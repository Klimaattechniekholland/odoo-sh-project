<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend Sale Order Form View -->
    <record id="view_order_form_inherit_proposal_quotations" model="ir.ui.view">
        <field name="name">sale.order.form.proposal.quotations</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            
            <!-- Add smart button for proposals -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button type="object" 
                        name="action_view_proposals"
                        class="oe_stat_button" 
                        icon="fa-clone"
                        invisible="is_proposal_quotation or not has_proposals">
                    <field name="proposal_count" widget="statinfo" string="Proposals"/>
                </button>
            </xpath>
            
            <!-- Add Create Proposal button in header -->
            <xpath expr="//button[@name='action_quotation_send']" position="after">
                <button name="action_create_proposal_quotation" 
                        type="object" 
                        string="Create Proposal" 
                        class="btn-secondary"
                        invisible="state not in ('draft', 'sent') or is_proposal_quotation"/>
            </xpath>
            
            <!-- Add Select Proposal button for proposal quotations -->
            <xpath expr="//button[@name='action_quotation_send']" position="after">
                <button name="action_select_proposal_quotation" 
                        type="object" 
                        string="Select This Proposal" 
                        class="oe_highlight btn-success"
                        invisible="not is_proposal_quotation or proposal_state != 'draft'"
                        confirm="Are you sure you want to select this proposal? All other proposals will be rejected and this proposal's content will be copied to the main quotation."/>
            </xpath>
            
            <!-- Add Proposal state field for proposal quotations -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="proposal_state" 
                       widget="statusbar" 
                       invisible="not is_proposal_quotation"
                       readonly="1"/>
            </xpath>
            
            <!-- Add Proposals tab after Order Lines tab (only for main quotations) -->
            <xpath expr="//page[@name='order_lines']" position="after">
                <page string="Proposals" 
                      name="proposal_quotations" 
                      invisible="state not in ('draft', 'sent') or is_proposal_quotation">
                    <field name="proposal_quotation_ids" context="{'default_is_proposal_quotation': True, 'default_parent_quotation_id': id}">
                        <list string="Proposal Quotations" create="true" delete="true">
                            <control>
                                <create string="Create a proposal quotation"/>
                            </control>
                            
                            <field name="name" readonly="proposal_state in ('selected', 'rejected')"/>
                            
                            <field name="partner_id" 
                                   string="Customer" 
                                   readonly="proposal_state in ('selected', 'rejected')"
                                   optional="hide"/>
                            
                            <field name="user_id" 
                                   string="Salesperson" 
                                   widget="many2one_avatar_user"
                                   readonly="proposal_state in ('selected', 'rejected')"
                                   optional="show"/>
                            
                            <field name="date_order" 
                                   string="Order Date"
                                   readonly="proposal_state in ('selected', 'rejected')"
                                   optional="show"/>
                            
                            <field name="validity_date" 
                                   string="Expiration"
                                   readonly="proposal_state in ('selected', 'rejected')"
                                   optional="show"/>
                            
                            <field name="amount_total" 
                                   string="Total" 
                                   widget="monetary"
                                   readonly="1"/>
                            
                            <field name="currency_id" column_invisible="True"/>
                            
                            <field name="proposal_state" 
                                   readonly="proposal_state in ('selected', 'rejected')"
                                   widget="badge" 
                                   decoration-success="proposal_state == 'selected'"
                                   decoration-warning="proposal_state == 'draft'"
                                   decoration-muted="proposal_state == 'rejected'"/>
                            
                            <!-- Select Proposal Button -->
                            <button name="action_select_proposal_quotation" 
                                    type="object" 
                                    string="Select" 
                                    icon="fa-check-circle" 
                                    class="btn-success"
                                    invisible="proposal_state != 'draft'"
                                    confirm="Are you sure you want to select this proposal quotation? All other proposals will be rejected and this proposal's content will be copied to the main quotation."/>
                            
                            <!-- Edit Proposal Button -->
                            <button name="%(sale.action_orders)d" 
                                    type="action" 
                                    string="Edit" 
                                    icon="fa-edit" 
                                    class="btn-primary"
                                    context="{'search_default_id': active_id}"
                                    invisible="proposal_state in ('selected', 'rejected')"/>
                            
                            <!-- View Proposal Button (for selected/rejected) -->
                            <button name="%(sale.action_orders)d" 
                                    type="action" 
                                    string="View" 
                                    icon="fa-eye" 
                                    class="btn-secondary"
                                    context="{'search_default_id': active_id}"
                                    invisible="proposal_state == 'draft'"/>
                            
                            <!-- Hidden fields needed for functionality -->
                            <field name="is_proposal_quotation" column_invisible="True"/>
                            <field name="state" column_invisible="True"/>
                            <field name="parent_quotation_id" column_invisible="True"/>
                        </list>
                        
                        <form string="Proposal Quotation">
                            <header>
                                <button name="action_select_proposal_quotation" 
                                        type="object" 
                                        string="Select This Proposal" 
                                        class="oe_highlight btn-success"
                                        invisible="proposal_state != 'draft'"
                                        confirm="Are you sure you want to select this proposal quotation? All other proposals will be rejected."/>
                                
                                <field name="proposal_state" widget="statusbar" readonly="1"/>
                            </header>
                            
                            <sheet>
                                <div class="oe_title">
                                    <h1>
                                        <field name="name" readonly="proposal_state in ('selected', 'rejected')"/>
                                    </h1>
                                </div>
                                
                                <div class="alert alert-info" invisible="proposal_state == 'draft'" role="alert">
                                    <span invisible="proposal_state != 'selected'">
                                        <strong>Selected:</strong> This proposal has been selected and its content copied to the main quotation.
                                    </span>
                                    <span invisible="proposal_state != 'rejected'">
                                        <strong>Rejected:</strong> This proposal was not selected.
                                    </span>
                                </div>
                                
                                <group>
                                    <group>
                                        <field name="partner_id" readonly="proposal_state in ('selected', 'rejected')"/>
                                        <field name="partner_invoice_id" readonly="proposal_state in ('selected', 'rejected')" groups="account.group_delivery_invoice_address"/>
                                        <field name="partner_shipping_id" readonly="proposal_state in ('selected', 'rejected')" groups="account.group_delivery_invoice_address"/>
                                        <field name="pricelist_id" readonly="proposal_state in ('selected', 'rejected')" groups="product.group_sale_pricelist"/>
                                    </group>
                                    <group>
                                        <field name="user_id" readonly="proposal_state in ('selected', 'rejected')"/>
                                        <field name="team_id" readonly="proposal_state in ('selected', 'rejected')"/>
                                        <field name="date_order" readonly="proposal_state in ('selected', 'rejected')"/>
                                        <field name="validity_date" readonly="proposal_state in ('selected', 'rejected')"/>
                                        <field name="parent_quotation_id" readonly="1"/>
                                    </group>
                                </group>
                                
                                <notebook>
                                    <page string="Order Lines" name="order_lines">
                                        <field name="order_line" 
                                               widget="section_and_note_one2many" 
                                               mode="tree,form"
                                               readonly="proposal_state in ('selected', 'rejected')">
                                            <form string="Sales Order Line">
                                                <sheet>
                                                    <group>
                                                        <group>
                                                            <field name="product_id"/>
                                                            <field name="product_uom_qty"/>
                                                            <field name="product_uom" groups="uom.group_uom"/>
                                                            <field name="price_unit"/>
                                                            <field name="discount" groups="product.group_discount_per_so_line"/>
                                                        </group>
                                                        <group>
                                                            <field name="tax_id" widget="many2many_tags"/>
                                                            <field name="price_subtotal"/>
                                                        </group>
                                                    </group>
                                                    <field name="name" placeholder="Description..."/>
                                                </sheet>
                                            </form>
                                            <list string="Sales Order Lines" editable="bottom">
                                                <field name="product_id"/>
                                                <field name="name"/>
                                                <field name="product_uom_qty"/>
                                                <field name="product_uom" groups="uom.group_uom"/>
                                                <field name="price_unit"/>
                                                <field name="discount" groups="product.group_discount_per_so_line"/>
                                                <field name="tax_id" widget="many2many_tags"/>
                                                <field name="price_subtotal"/>
                                            </list>
                                        </field>
                                    </page>
                                    <page string="Other Information" name="other_info">
                                        <group>
                                            <group>
                                                <field name="client_order_ref"/>
                                                <field name="payment_term_id"/>
                                                <field name="fiscal_position_id"/>
                                            </group>
                                            <group>
                                                <field name="warehouse_id" groups="stock.group_stock_multi_warehouses"/>
                                                <field name="company_id" groups="base.group_multi_company"/>
                                                <field name="currency_id" groups="base.group_multi_currency"/>
                                            </group>
                                        </group>
                                        <field name="note" placeholder="Terms and conditions..."/>
                                    </page>
                                </notebook>
                                
                                <!-- Hidden fields -->
                                <field name="is_proposal_quotation" invisible="1"/>
                                <field name="state" invisible="1"/>
                            </sheet>
                        </form>
                    </field>
                </page>
            </xpath>
            
            <!-- Show parent quotation info for proposal quotations -->
            <xpath expr="//group[@name='sale_header']" position="before">
                <div class="alert alert-warning" invisible="not is_proposal_quotation" role="alert">
                    <strong>Proposal Quotation</strong> - This is a proposal for quotation 
                    <field name="parent_quotation_id" readonly="1" class="fw-bold"/>
                </div>
            </xpath>
            
            <!-- Hide some buttons for proposal quotations -->
            <xpath expr="//button[@name='action_quotation_send']" position="attributes">
                <attribute name="invisible">is_proposal_quotation</attribute>
            </xpath>
            
            <xpath expr="//button[@name='action_confirm']" position="attributes">
                <attribute name="invisible">is_proposal_quotation</attribute>
            </xpath>
            
            <!-- Add hidden fields -->
            <xpath expr="//field[@name='partner_id']" position="before">
                <field name="is_proposal_quotation" invisible="1"/>
                <field name="has_proposals" invisible="1"/>
                <field name="proposal_count" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Filter proposal quotations from main sale order list -->
    <record id="view_sales_order_filter_inherit_proposals" model="ir.ui.view">
        <field name="name">sale.order.select.proposals</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.sale_order_view_search_inherit_quotation"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='sales']" position="after">
                <separator/>
                <filter string="Main Quotations" name="main_quotations" domain="[('is_proposal_quotation', '=', False)]"/>
                <filter string="Proposal Quotations" name="proposal_quotations" domain="[('is_proposal_quotation', '=', True)]"/>
            </xpath>
        </field>
    </record>

</odoo>